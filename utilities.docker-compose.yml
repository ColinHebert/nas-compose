services:
  watchtower:
    image: containrrr/watchtower
    environment:
      DOCKER_HOST: tcp://docker:2375
      WATCHTOWER_INCLUDE_RESTARTING: true
      WATCHTOWER_INCLUDE_STOPPED: true
      WATCHTOWER_MONITOR_ONLY: true
      WATCHTOWER_NOTIFICATION_URL: /run/secrets/watchtower_notification_url
    networks:
      - docker
    secrets:
      - watchtower_notification_url
    restart: unless-stopped

  smokeping:
    image: linuxserver/smokeping
    environment:
      PUID: ${NASCOMPOSE_UID?}
      PGID: ${NASCOMPOSE_GID?}
    networks:
      - traefik
    volumes:
      - smokeping_data:/data/
      - smokeping_config:/config/
    restart: unless-stopped
    labels:
      traefik.enable: true
      traefik.http.routers.smokeping.middlewares: authelia@file

  duckdns:
    image: linuxserver/duckdns
    environment:
      - SUBDOMAINS=${NASCOMPOSE_DUCKDNS_DOMAIN?}
      - FILE__TOKEN=/run/secrets/duckdns_token
    secrets:
      - duckdns_token
    restart: unless-stopped

  heimdall:
    image: linuxserver/heimdall
    environment:
      PUID: ${NASCOMPOSE_UID?}
      PGID: ${NASCOMPOSE_GID?}
    networks:
      - traefik
    volumes:
      - heimdall_config:/config/
    restart: unless-stopped
    labels:
      traefik.enable: true
      traefik.http.routers.smokeping.middlewares: authelia@file

networks:
  docker:
    external: true
  traefik:
    external: true

volumes:
  smokeping_data:
    driver_opts:
      type: none
      o: bind
      device: ${NASCOMPOSE_SERVICES?}/volumes/smokeping/data/
  smokeping_config:
    driver_opts:
      type: none
      o: bind
      device: ${NASCOMPOSE_SERVICES?}/volumes/smokeping/config/
  heimdall_config:
    driver_opts:
      type: none
      o: bind
      device: ${NASCOMPOSE_SERVICES?}/volumes/heimdall/config/

secrets:
  duckdns_token:
    file: ${NASCOMPOSE_SERVICES?}/secrets/duckdns/duckdns_token
  watchtower_notification_url:
    file: ${NASCOMPOSE_SERVICES?}/secrets/watchtower/notification_url
